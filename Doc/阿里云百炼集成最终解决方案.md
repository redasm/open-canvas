# é˜¿é‡Œäº‘ç™¾ç‚¼é›†æˆæœ€ç»ˆè§£å†³æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

### æµ‹è¯•ç»“æœ
1. âœ… **ç›´æ¥ API è°ƒç”¨æˆåŠŸ**ï¼šä½¿ç”¨ PowerShell ç›´æ¥è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼ API æˆåŠŸ
   ```
   model: deepseek-r1
   usage: @{prompt_tokens=4; completion_tokens=281; total_tokens=285}
   ```

2. âŒ **LangChain é›†æˆå¤±è´¥**ï¼š
   - ç¬¬ä¸€æ¬¡é”™è¯¯ï¼š`401 Incorrect API key provided` (OpenAI æä¾›å•†)
   - ç¬¬äºŒæ¬¡é”™è¯¯ï¼š`403 "unauthorized"` (Fireworks æä¾›å•†)

### æ ¹æœ¬åŸå› 

æ ¹æ®[é˜¿é‡Œäº‘ç™¾ç‚¼æ§åˆ¶å°æ–‡æ¡£](https://bailian.console.aliyun.com/?spm=5176.29597918.resourceCenter.1.6d7d7b08wQgaGB&tab=api#/api/?type=model&url=2868565)ï¼Œæ­£ç¡®çš„è°ƒç”¨æ–¹å¼åº”è¯¥æ˜¯ï¼š

```javascript
const openai = new OpenAI({
    apiKey: process.env.DASHSCOPE_API_KEY, 
    baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
});
```

**é—®é¢˜åœ¨äº**ï¼š
- LangChain çš„æä¾›å•†ï¼ˆOpenAIã€Fireworks ç­‰ï¼‰éƒ½ä¼šåœ¨ `baseUrl` åé¢è‡ªåŠ¨æ·»åŠ è·¯å¾„
- OpenAI æä¾›å•†ï¼šæ·»åŠ  `/chat/completions`
- Fireworks æä¾›å•†ï¼šå¯èƒ½æ·»åŠ  `/inference/v1/chat/completions` æˆ–å…¶ä»–è·¯å¾„

## è§£å†³æ–¹æ¡ˆä¸€ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„ LangChain ChatModel

ç”±äºæ ‡å‡†æä¾›å•†éƒ½æ— æ³•å®Œå…¨æ§åˆ¶ URL æ„å»ºè¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ ChatModelï¼š

```typescript
// apps/agents/src/utils.ts

import { ChatOpenAI } from "@langchain/openai";

// ä¸ºé˜¿é‡Œäº‘ç™¾ç‚¼åˆ›å»ºè‡ªå®šä¹‰é…ç½®
if (customModelName.includes("fireworks/")) {
  let actualModelName = providerConfig.modelName;
  
  // æ¨¡å‹åç§°æ˜ å°„
  if (actualModelName.includes("deepseek-r1")) {
    actualModelName = "deepseek-r1";
  } else if (actualModelName.includes("deepseek-v3")) {
    actualModelName = "deepseek-v3";
  }
  
  // ç›´æ¥ä½¿ç”¨ ChatOpenAI å¹¶å®Œå…¨è‡ªå®šä¹‰é…ç½®
  const model = new ChatOpenAI({
    modelName: actualModelName,
    openAIApiKey: process.env.FIREWORKS_API_KEY,
    configuration: {
      baseURL: "https://dashscope.aliyuncs.com/compatible-mode/v1",
    },
    temperature: 0.5,
    maxTokens: 4096,
  });
  
  return model;
}
```

## è§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤ç«¯ç‚¹

ä¿®æ”¹ç¯å¢ƒå˜é‡æ¥è¦†ç›– OpenAI çš„é»˜è®¤ç«¯ç‚¹ï¼š

```bash
# .env æ–‡ä»¶
OPENAI_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
OPENAI_API_KEY=sk-5f7a6e663fab4487bbc16d3a5c7e1912
```

ç„¶ååœ¨ä»£ç ä¸­ä½¿ç”¨ OpenAI æä¾›å•†ï¼š

```typescript
return {
  ...providerConfig,
  modelName: actualModelName,
  modelProvider: "openai",
  apiKey: process.env.OPENAI_API_KEY,
  baseUrl: process.env.OPENAI_API_BASE,
};
```

## è§£å†³æ–¹æ¡ˆä¸‰ï¼šä¿®æ”¹ getModelFromConfig å‡½æ•°

ç›´æ¥åœ¨ `getModelFromConfig` å‡½æ•°ä¸­å¤„ç†é˜¿é‡Œäº‘ç™¾ç‚¼çš„ç‰¹æ®Šæƒ…å†µï¼š

```typescript
export async function getModelFromConfig(
  config: LangGraphRunnableConfig,
  extra?: {
    temperature?: number;
    maxTokens?: number;
    isToolCalling?: boolean;
  }
): Promise<ReturnType<typeof initChatModel>> {
  const {
    modelName,
    modelProvider,
    azureConfig,
    apiKey,
    baseUrl,
    modelConfig,
  } = getModelConfig(config, {
    isToolCalling: extra?.isToolCalling,
  });

  // ç‰¹æ®Šå¤„ç†é˜¿é‡Œäº‘ç™¾ç‚¼
  if (baseUrl?.includes("dashscope.aliyuncs.com")) {
    const { ChatOpenAI } = await import("@langchain/openai");
    return new ChatOpenAI({
      modelName,
      openAIApiKey: apiKey,
      configuration: {
        baseURL: baseUrl,
      },
      temperature: extra?.temperature ?? 0.5,
      maxTokens: extra?.maxTokens,
    });
  }

  // åŸæœ‰çš„ initChatModel é€»è¾‘
  return await initChatModel(modelName, {
    modelProvider,
    // ... å…¶ä»–å‚æ•°
  });
}
```

## æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆä¸‰ï¼ˆæœ€å°ä¾µå…¥æ€§ï¼‰

æ–¹æ¡ˆä¸‰æ˜¯æœ€æ¨èçš„ï¼Œå› ä¸ºï¼š
1. âœ… æœ€å°ç¨‹åº¦ä¿®æ”¹ç°æœ‰ä»£ç 
2. âœ… ä¸å½±å“å…¶ä»–æä¾›å•†
3. âœ… å®Œå…¨æ§åˆ¶é˜¿é‡Œäº‘ç™¾ç‚¼çš„ API è°ƒç”¨
4. âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

## å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®æ”¹ getModelFromConfig å‡½æ•°

åœ¨ `apps/agents/src/utils.ts` çš„ `getModelFromConfig` å‡½æ•°å¼€å¤´æ·»åŠ ï¼š

```typescript
export async function getModelFromConfig(
  config: LangGraphRunnableConfig,
  extra?: {
    temperature?: number;
    maxTokens?: number;
    isToolCalling?: boolean;
  }
): Promise<ReturnType<typeof initChatModel>> {
  const {
    modelName,
    modelProvider,
    azureConfig,
    apiKey,
    baseUrl,
    modelConfig,
  } = getModelConfig(config, {
    isToolCalling: extra?.isToolCalling,
  });
  
  const { temperature = 0.5, maxTokens } = {
    temperature: modelConfig?.temperatureRange.current,
    maxTokens: modelConfig?.maxTokens.current,
    ...extra,
  };

  // ğŸ”§ ç‰¹æ®Šå¤„ç†é˜¿é‡Œäº‘ç™¾ç‚¼
  if (baseUrl?.includes("dashscope.aliyuncs.com")) {
    const { ChatOpenAI } = await import("@langchain/openai");
    return new ChatOpenAI({
      modelName,
      openAIApiKey: apiKey,
      configuration: {
        baseURL: baseUrl,
      },
      temperature,
      maxTokens,
    }) as any;
  }

  // ... åŸæœ‰ä»£ç ç»§ç»­
}
```

### æ­¥éª¤ 2ï¼šç¡®ä¿ baseUrl æ­£ç¡®

åœ¨ `getModelConfig` å‡½æ•°ä¸­ï¼š

```typescript
if (customModelName.includes("fireworks/")) {
  let actualModelName = providerConfig.modelName;
  
  // æ¨¡å‹åç§°æ˜ å°„
  if (actualModelName.includes("deepseek-r1")) {
    actualModelName = "deepseek-r1";
  } else if (actualModelName.includes("deepseek-v3")) {
    actualModelName = "deepseek-v3";
  }
  
  return {
    ...providerConfig,
    modelName: actualModelName,
    modelProvider: "fireworks", // è¿™ä¸ªå€¼ä¸é‡è¦ï¼Œå› ä¸ºä¼šè¢«ç‰¹æ®Šå¤„ç†
    apiKey: process.env.FIREWORKS_API_KEY,
    baseUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1", // åŸºç¡€ URL
  };
}
```

### æ­¥éª¤ 3ï¼šç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
FIREWORKS_API_KEY=sk-5f7a6e663fab4487bbc16d3a5c7e1912
NEXT_PUBLIC_FIREWORKS_ENABLED=true
```

### æ­¥éª¤ 4ï¼šé‡å¯æœåŠ¡

```bash
# åœæ­¢æœåŠ¡
taskkill /F /IM node.exe

# é‡æ–°æ„å»º
cd apps/agents && yarn build

# å¯åŠ¨æœåŠ¡
cd apps/agents && yarn dev
cd apps/web && yarn dev
```

## æµ‹è¯•éªŒè¯

### 1. ç›´æ¥ API æµ‹è¯•
```powershell
$headers = @{
    "Authorization" = "Bearer sk-5f7a6e663fab4487bbc16d3a5c7e1912"
    "Content-Type" = "application/json"
}

$body = @{
    model = "deepseek-r1"
    messages = @(
        @{
            role = "user"
            content = "ä½ æ˜¯è°"
        }
    )
    stream = $false
} | ConvertTo-Json -Depth 3

Invoke-RestMethod -Uri "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" -Method POST -Headers $headers -Body $body
```

### 2. Open Canvas æµ‹è¯•
1. æ‰“å¼€ `http://localhost:3000`
2. é€‰æ‹© Fireworks åˆ†ç»„ä¸‹çš„ DeepSeek R1 æ¨¡å‹
3. å‘é€æ¶ˆæ¯æµ‹è¯•

## æ€»ç»“

æ ¸å¿ƒé—®é¢˜æ˜¯ LangChain çš„æ ‡å‡†æä¾›å•†æ— æ³•å®Œå…¨è‡ªå®šä¹‰ URL æ„å»ºè¿‡ç¨‹ã€‚é€šè¿‡åœ¨ `getModelFromConfig` å‡½æ•°ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨ `ChatOpenAI` ç±»å¹¶å®Œå…¨æ§åˆ¶é…ç½®ï¼Œå¯ä»¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è¿™ä¸ªæ–¹æ¡ˆï¼š
- âœ… ä¿æŒäº†ä»£ç çš„æ•´æ´æ€§
- âœ… ä¸å½±å“å…¶ä»–æ¨¡å‹æä¾›å•†
- âœ… å®Œå…¨æ§åˆ¶é˜¿é‡Œäº‘ç™¾ç‚¼çš„ API è°ƒç”¨
- âœ… æ˜“äºè°ƒè¯•å’Œç»´æŠ¤
