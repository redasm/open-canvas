# Open Canvas 技术架构总览

## 概述

Open Canvas 是一个基于 LangChain 和 LangGraph 构建的 AI 应用平台，支持多种大语言模型，提供智能对话、工件生成、代码编辑等功能。本文档从技术架构角度全面分析项目的设计理念和实现细节。

## 1. 整体架构

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Open Canvas Platform                     │
├─────────────────────────────────────────────────────────────────┤
│  Frontend (Next.js)          │  Backend (LangGraph)             │
│  ┌─────────────────────────┐ │  ┌─────────────────────────────┐ │
│  │  React Components       │ │  │  LangGraph Nodes            │ │
│  │  - Chat Interface       │ │  │  - generatePath            │ │
│  │  - Model Selector       │ │  │  - generateArtifact        │ │
│  │  - Artifact Editor      │ │  │  - rewriteArtifact         │ │
│  │  - Canvas UI            │ │  │  - updateArtifact          │ │
│  └─────────────────────────┘ │  │  - reflect                 │ │
│  ┌─────────────────────────┐ │  │  - generateFollowup        │ │
│  │  Context Providers      │ │  └─────────────────────────────┘ │
│  │  - GraphContext         │ │  ┌─────────────────────────────┐ │
│  │  - ThreadProvider       │ │  │  LangChain Integration     │ │
│  │  - UserContext          │ │  │  - Model Configuration      │ │
│  │  - AssistantContext     │ │  │  - Tool Binding            │ │
│  └─────────────────────────┘ │  │  - Message Handling        │ │
│  ┌─────────────────────────┐ │  │  - API Calls               │ │
│  │  API Routes             │ │  └─────────────────────────────┘ │
│  │  - Proxy to LangGraph   │ │  ┌─────────────────────────────┐ │
│  │  - Authentication       │ │  │  State Management           │ │
│  │  - File Upload          │ │  │  - Graph State              │ │
│  └─────────────────────────┘ │  │  - Memory Store             │ │
└─────────────────────────────────────────────────────────────────┘
│  ┌─────────────────────────┐ │  │  - Thread Store             │ │
│  │  External Services      │ │  └─────────────────────────────┘ │
│  │  - Supabase (Auth/DB)   │ │  ┌─────────────────────────────┐ │
│  │  - LangSmith (Tracing)  │ │  │  Multiple Graphs            │ │
│  │  - Model Providers     │ │  │  - Main Agent Graph        │ │
│  │  - OpenAI, Anthropic   │ │  │  - Reflection Graph         │ │
│  │  - Google, Fireworks   │ │  │  - Thread Title Graph      │ │
│  │  - Groq, Ollama        │ │  │  - Summarizer Graph         │ │
│  └─────────────────────────┘ │  │  - Web Search Graph         │ │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈

#### 前端技术栈
- **Next.js 14**: React 框架，提供 SSR/SSG 支持
- **TypeScript**: 类型安全的 JavaScript
- **Tailwind CSS**: 实用优先的 CSS 框架
- **Framer Motion**: 动画库
- **React Hook Form**: 表单管理
- **Zustand**: 状态管理

#### 后端技术栈
- **LangGraph**: 工作流编排和状态管理
- **LangChain**: LLM 集成和工具调用
- **Node.js**: JavaScript 运行时
- **TypeScript**: 类型安全
- **Supabase**: 认证和数据库服务

#### 外部服务
- **模型提供商**: OpenAI, Anthropic, Google, Fireworks, Groq, Ollama
- **数据库**: Supabase PostgreSQL
- **认证**: Supabase Auth
- **追踪**: LangSmith
- **文件存储**: Supabase Storage

## 2. 核心组件分析

### 2.1 前端架构

#### 2.1.1 组件层次结构

```
App Layout
├── AuthProvider (认证上下文)
├── UserContext (用户上下文)
├── ThreadProvider (线程管理)
├── GraphContext (图状态管理)
├── AssistantContext (助手配置)
└── Main Content
    ├── Chat Interface
    │   ├── Message List
    │   ├── Input Area
    │   └── Model Selector
    ├── Artifact Canvas
    │   ├── Code Editor
    │   ├── Markdown Renderer
    │   └── Quick Actions
    └── Sidebar
        ├── Thread List
        └── Settings
```

#### 2.1.2 状态管理

```typescript
// GraphContext - 管理图执行状态
interface GraphData {
  runId: string | undefined;
  isStreaming: boolean;
  error: boolean;
  selectedBlocks: TextHighlight | undefined;
  messages: BaseMessage[];
  artifact: ArtifactV3 | undefined;
  updateRenderedArtifactRequired: boolean;
  isArtifactSaved: boolean;
  firstTokenReceived: boolean;
  feedbackSubmitted: boolean;
  artifactUpdateFailed: boolean;
  chatStarted: boolean;
  searchEnabled: boolean;
}

// ThreadProvider - 管理线程和模型配置
interface ThreadContentType {
  threadId: string | null;
  userThreads: Thread[];
  isUserThreadsLoading: boolean;
  modelName: ALL_MODEL_NAMES;
  modelConfigs: Record<ALL_MODEL_NAMES, CustomModelConfig>;
  createThreadLoading: boolean;
  // ... 更多状态和方法
}
```

### 2.2 后端架构

#### 2.2.1 LangGraph 工作流

```typescript
// 主工作流图
const builder = new StateGraph(OpenCanvasGraphAnnotation)
  .addNode("generatePath", generatePath)           // 路径生成
  .addNode("generateArtifact", generateArtifact)  // 工件生成
  .addNode("rewriteArtifact", rewriteArtifact)    // 工件重写
  .addNode("updateArtifact", updateArtifact)      // 工件更新
  .addNode("generateFollowup", generateFollowup)  // 后续生成
  .addNode("reflect", reflectNode)                // 反思节点
  .addNode("generateTitle", generateTitleNode)    // 标题生成
  .addNode("summarizer", summarizer)              // 摘要生成
  .addNode("webSearch", webSearchGraph)           // 网络搜索
  // 条件路由
  .addConditionalEdges("generatePath", routeNode, [
    "updateArtifact", "rewriteArtifactTheme", "replyToGeneralInput",
    "generateArtifact", "rewriteArtifact", "customAction",
    "updateHighlightedText", "webSearch"
  ])
  // 顺序执行
  .addEdge("generateArtifact", "generateFollowup")
  .addEdge("generateFollowup", "reflect")
  .addEdge("reflect", "cleanState");
```

#### 2.2.2 多图协作

```json
// langgraph.json
{
  "graphs": {
    "agent": "./apps/agents/src/open-canvas/index.ts:graph",
    "reflection": "./apps/agents/src/reflection/index.ts:graph",
    "thread_title": "./apps/agents/src/thread-title/index.ts:graph",
    "summarizer": "./apps/agents/src/summarizer/index.ts:graph",
    "web_search": "./apps/agents/src/web-search/index.ts:graph"
  }
}
```

### 2.3 状态管理架构

#### 2.3.1 图状态定义

```typescript
export const OpenCanvasGraphAnnotation = Annotation.Root({
  // 消息状态
  ...MessagesAnnotation.spec,
  _messages: Annotation<BaseMessage[], Messages>({
    reducer: (state, update) => {
      const latestMsg = Array.isArray(update)
        ? update[update.length - 1]
        : update;
      if (isSummaryMessage(latestMsg)) {
        return messagesStateReducer([], update);
      }
      return messagesStateReducer(state, update);
    },
    default: () => [],
  }),
  
  // 工件状态
  artifact: Annotation<ArtifactV3>,
  
  // 高亮状态
  highlightedCode: Annotation<CodeHighlight | undefined>,
  highlightedText: Annotation<TextHighlight | undefined>,
  
  // 路由状态
  next: Annotation<string | undefined>,
  
  // 配置状态
  language: Annotation<LanguageOptions | undefined>,
  artifactLength: Annotation<ArtifactLengthOptions | undefined>,
  regenerateWithEmojis: Annotation<boolean | undefined>,
  readingLevel: Annotation<ReadingLevelOptions | undefined>,
  addComments: Annotation<boolean | undefined>,
});
```

#### 2.3.2 状态持久化

- **内存状态**: LangGraph 运行时状态
- **持久化状态**: Supabase 数据库存储
- **会话状态**: 浏览器本地存储

## 3. 数据流分析

### 3.1 用户交互流程

```
用户输入 → 前端验证 → API 代理 → LangGraph 节点 → LangChain 调用 → 模型响应 → 状态更新 → 前端渲染
```

### 3.2 详细数据流

1. **用户输入处理**
   ```typescript
   // 前端收集用户输入
   const input = {
     messages: [...existingMessages, newUserMessage],
     artifact: currentArtifact,
     // ... 其他上下文
   };
   ```

2. **API 代理转发**
   ```typescript
   // apps/web/src/app/api/[..._path]/route.ts
   const res = await fetch(
     `${LANGGRAPH_API_URL}/${path}${queryString}`,
     {
       method,
       headers: {
         "x-api-key": process.env.LANGCHAIN_API_KEY || "",
         "Content-Type": "application/json",
       },
       body: JSON.stringify({
         ...parsedBody,
         config: {
           ...parsedBody.config,
           configurable: {
             ...parsedBody.config.configurable,
             supabase_session: session,
             supabase_user_id: user.id,
           },
         },
       }),
     }
   );
   ```

3. **LangGraph 节点处理**
   ```typescript
   // 节点内部使用 LangChain
   const model = await getModelFromConfig(config, {
     temperature: 0.5,
     isToolCalling: true,
   });
   
   const modelWithTool = model.bindTools([...tools]);
   const response = await modelWithTool.invoke([...messages]);
   ```

4. **状态更新和返回**
   ```typescript
   return {
     artifact: newArtifact,
     messages: [...state.messages, newMessage],
     // ... 其他状态更新
   };
   ```

## 4. 模型集成架构

### 4.1 模型配置系统

```typescript
// 统一的模型配置接口
export const getModelConfig = (
  config: LangGraphRunnableConfig,
  extra?: { isToolCalling?: boolean; }
): {
  modelName: string;
  modelProvider: string;
  modelConfig?: CustomModelConfig;
  azureConfig?: AzureConfig;
  apiKey?: string;
  baseUrl?: string;
} => {
  // 根据模型名称路由到不同的提供商
  if (customModelName.startsWith("azure/")) {
    return { /* Azure 配置 */ };
  }
  if (customModelName.includes("gpt-")) {
    return { /* OpenAI 配置 */ };
  }
  if (customModelName.includes("claude-")) {
    return { /* Anthropic 配置 */ };
  }
  // ... 其他提供商
};
```

### 4.2 支持的模型提供商

| 提供商 | 模型示例 | 端点类型 | 特殊配置 |
|--------|----------|----------|----------|
| OpenAI | gpt-4o, o1-mini | 默认端点 | 工具调用回退 |
| Anthropic | claude-3-5-sonnet | 默认端点 | 无 |
| Google | gemini-2.0-flash | 默认端点 | 工具调用回退 |
| Fireworks | llama-v3p3-70b | 默认端点 | 工具调用回退 |
| Groq | deepseek-r1-distill | 默认端点 | 无 |
| Azure | azure/gpt-4o-mini | Azure 配置 | azureConfig 对象 |
| Ollama | ollama-llama3.3 | 自定义端点 | baseUrl 配置 |

### 4.3 工具调用架构

```typescript
// 工具绑定示例
const modelWithTool = model.bindTools(
  [
    {
      name: "generate_artifact",
      description: "Generate a new artifact",
      schema: ARTIFACT_TOOL_SCHEMA,
    },
  ],
  {
    tool_choice: "generate_artifact",
  }
);

// 工具调用响应处理
const response = await modelWithTool.invoke([...messages]);
const args = response.tool_calls?.[0].args;
```

## 5. 安全架构

### 5.1 认证和授权

```typescript
// Supabase 认证集成
export async function verifyUserAuthenticated() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE!
  );
  
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    throw new Error("Unauthorized");
  }
  
  return { user };
}
```

### 5.2 API 安全

- **API 密钥验证**: 使用 LangChain API 密钥
- **用户会话验证**: Supabase 会话验证
- **CORS 配置**: 适当的跨域资源共享设置
- **输入验证**: 严格的输入参数验证

### 5.3 数据安全

- **敏感数据加密**: API 密钥等敏感信息加密存储
- **数据隔离**: 用户数据按用户 ID 隔离
- **访问控制**: 基于角色的访问控制

## 6. 性能优化

### 6.1 前端优化

- **代码分割**: Next.js 自动代码分割
- **懒加载**: 组件和路由懒加载
- **缓存策略**: 适当的缓存策略
- **流式渲染**: 支持流式数据渲染

### 6.2 后端优化

- **并行执行**: LangGraph 支持节点并行执行
- **状态缓存**: 智能的状态缓存机制
- **连接池**: 数据库连接池管理
- **异步处理**: 非阻塞的异步处理

### 6.3 模型调用优化

- **工具调用回退**: 智能的模型回退机制
- **批量处理**: 批量 API 调用
- **错误重试**: 自动重试机制
- **超时控制**: 合理的超时设置

## 7. 监控和调试

### 7.1 LangSmith 集成

```typescript
// 追踪配置
const response = await modelWithTool.invoke(
  [...messages],
  { runName: "generate_artifact" }
);
```

### 7.2 日志系统

- **结构化日志**: 使用结构化日志格式
- **错误追踪**: 完整的错误堆栈追踪
- **性能监控**: 关键指标监控
- **用户行为分析**: 用户交互分析

### 7.3 调试工具

- **LangGraph Studio**: 可视化工作流调试
- **开发工具**: 丰富的开发调试工具
- **测试框架**: 完整的测试覆盖

## 8. 扩展性设计

### 8.1 模块化架构

- **插件系统**: 支持自定义节点和工具
- **配置驱动**: 基于配置的功能扩展
- **API 扩展**: 灵活的 API 扩展机制

### 8.2 多租户支持

- **用户隔离**: 完整的用户数据隔离
- **配置隔离**: 用户级别的配置管理
- **资源限制**: 用户级别的资源限制

### 8.3 国际化支持

- **多语言界面**: 支持多种界面语言
- **本地化内容**: 本地化的提示和内容
- **时区支持**: 多时区支持

## 9. 部署架构

### 9.1 容器化部署

```dockerfile
# Docker 配置示例
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

### 9.2 微服务架构

- **前端服务**: Next.js 应用
- **后端服务**: LangGraph 服务
- **数据库服务**: Supabase 服务
- **外部服务**: 各种模型提供商

### 9.3 云原生支持

- **Kubernetes**: 容器编排支持
- **CI/CD**: 持续集成和部署
- **监控告警**: 完整的监控告警系统
- **自动扩缩容**: 基于负载的自动扩缩容

## 10. 总结

Open Canvas 采用了现代化的技术架构，具有以下特点：

### 10.1 技术优势

1. **分层架构**: 清晰的前后端分离和职责划分
2. **模块化设计**: 高度模块化的组件设计
3. **类型安全**: 全面的 TypeScript 类型支持
4. **可扩展性**: 良好的扩展性和可维护性
5. **性能优化**: 多层次的性能优化策略

### 10.2 架构亮点

1. **LangGraph + LangChain 协作**: 工作流编排与 LLM 交互的完美结合
2. **多模型支持**: 统一的模型配置和调用接口
3. **状态管理**: 复杂的状态管理和持久化机制
4. **实时交互**: 流式数据处理和实时用户交互
5. **安全可靠**: 完善的安全机制和错误处理

### 10.3 发展方向

1. **功能扩展**: 更多 AI 功能和工具集成
2. **性能提升**: 进一步的性能优化和扩展性改进
3. **用户体验**: 更好的用户界面和交互体验
4. **生态建设**: 更丰富的插件和扩展生态
5. **企业级特性**: 更多企业级功能和部署选项

通过这种精心设计的架构，Open Canvas 成功构建了一个功能强大、易于扩展的 AI 应用平台，为开发者提供了构建复杂 AI 应用的完整解决方案。
