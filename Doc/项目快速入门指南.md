# Open Canvas 项目快速入门指南

## 📋 目录

1. [项目概述](#项目概述)
2. [技术架构](#技术架构)
3. [环境准备](#环境准备)
4. [快速启动](#快速启动)
5. [核心概念](#核心概念)
6. [开发指南](#开发指南)
7. [常见问题](#常见问题)
8. [进阶定制](#进阶定制)

## 🎯 项目概述

### 什么是 Open Canvas？

Open Canvas 是一个开源的 AI 协作平台，灵感来源于 OpenAI 的 Canvas，但具有以下独特优势：

- **🔓 完全开源**: 前端、后端、AI 代理全部开源，MIT 许可证
- **🧠 内置记忆系统**: 自动生成用户偏好和聊天历史记忆
- **📄 支持现有文档**: 可以从空白文档或现有代码开始协作
- **🔄 工件版本管理**: 支持代码和文档的版本历史
- **🎨 多格式支持**: 同时支持代码、Markdown 和混合格式

### 核心功能

- **智能对话**: 与 AI 助手进行自然语言交互
- **代码生成**: 生成、编辑和优化代码
- **文档协作**: 创建和编辑 Markdown 文档
- **记忆系统**: 自动学习和记住用户偏好
- **快速操作**: 预定义和自定义的快速操作
- **实时渲染**: 边编辑边预览 Markdown 效果

## 🏗️ 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Open Canvas Platform                    │
├─────────────────────────────────────────────────────────────┤
│  Frontend (Next.js)        │    Backend (LangGraph)        │
│  ┌─────────────────────────┐ │  ┌─────────────────────────┐ │
│  │  React Components       │ │  │  LangGraph Nodes        │ │
│  │  - Chat Interface       │ │  │  - generatePath         │ │
│  │  - Model Selector       │ │  │  - generateArtifact     │ │
│  │  - Artifact Editor      │ │  │  - rewriteArtifact      │ │
│  │  - Canvas UI            │ │  │  - updateArtifact       │ │
│  └─────────────────────────┘ │  │  - reflect              │ │
│  ┌─────────────────────────┐ │  │  - generateFollowup     │ │
│  │  Context Providers      │ │  │  - webSearch            │ │
│  │  - GraphContext         │ │  └─────────────────────────┘ │
│  │  - ThreadProvider       │ │  ┌─────────────────────────┐ │
│  │  - UserContext          │ │  │  LangChain Integration  │ │
│  │  - AssistantContext     │ │  │  - Model Configuration  │ │
│  └─────────────────────────┘ │  │  - Tool Binding         │ │
│  ┌─────────────────────────┐ │  │  - Message Handling     │ │
│  │  API Routes             │ │  │  - API Calls            │ │
│  │  - Proxy to LangGraph   │ │  └─────────────────────────┘ │
│  │  - Authentication       │ │  ┌─────────────────────────┐ │
│  │  - File Upload          │ │  │  State Management       │ │
│  └─────────────────────────┘ │  │  - Graph State          │ │
└─────────────────────────────────────────────────────────────┘
│  ┌─────────────────────────┐ │  │  - Memory Store         │ │
│  │  External Services      │ │  │  - Thread Store         │ │
│  │  - Supabase (Auth/DB)   │ │  └─────────────────────────┘ │
│  │  - LangSmith (Tracing)  │ │  ┌─────────────────────────┐ │
│  │  - Model Providers      │ │  │  Multiple Graphs        │ │
│  │  - OpenAI, Anthropic    │ │  │  - Main Agent Graph     │ │
│  │  - Google, Fireworks    │ │  │  - Reflection Graph     │ │
│  │  - Groq, Ollama         │ │  │  - Thread Title Graph   │ │
│  └─────────────────────────┘ │  │  - Summarizer Graph     │ │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈

#### 前端技术
- **框架**: Next.js 14 + React + TypeScript
- **样式**: Tailwind CSS + Framer Motion
- **状态管理**: React Context + Zustand
- **UI 组件**: Radix UI + 自定义组件
- **编辑器**: CodeMirror + BlockNote

#### 后端技术
- **工作流引擎**: LangGraph
- **LLM 集成**: LangChain
- **运行时**: Node.js + TypeScript
- **数据库**: Supabase PostgreSQL
- **认证**: Supabase Auth

#### 外部服务
- **模型提供商**: OpenAI, Anthropic, Google, Fireworks, Groq, Ollama
- **追踪服务**: LangSmith
- **文件存储**: Supabase Storage

## 🛠️ 环境准备

### 系统要求

- **Node.js**: 20.x 或更高版本
- **包管理器**: Yarn 1.22.22
- **操作系统**: Windows, macOS, Linux

### 必需的服务和 API 密钥

#### 1. 认证服务
- **Supabase**: 用于用户认证和数据库
  - 创建项目: [https://supabase.com/dashboard/projects](https://supabase.com/dashboard/projects)
  - 获取 URL 和 API Key

#### 2. LLM 模型 API 密钥
- **OpenAI**: [https://platform.openai.com/signup/](https://platform.openai.com/signup/)
- **Anthropic**: [https://console.anthropic.com/](https://console.anthropic.com/)
- **Google GenAI**: [https://aistudio.google.com/apikey](https://aistudio.google.com/apikey) (可选)
- **Fireworks AI**: [https://fireworks.ai/login](https://fireworks.ai/login) (可选)
- **Groq AI**: [https://groq.com](https://groq.com) (可选)

#### 3. 可选服务
- **LangSmith**: [https://smith.langchain.com/](https://smith.langchain.com/) (用于追踪和监控)
- **FireCrawl**: [https://firecrawl.dev](https://firecrawl.dev) (用于网页抓取)
- **ExaSearch**: [https://exa.ai](https://exa.ai) (用于网络搜索)

### 安装步骤

#### 1. 克隆项目
```bash
git clone https://github.com/langchain-ai/open-canvas.git
cd open-canvas
```

#### 2. 安装依赖
```bash
yarn install
```

#### 3. 构建项目
```bash
yarn build
```

#### 4. 配置环境变量

**根目录 `.env` 文件** (LangGraph 服务使用):
```bash
# 必需 - LLM API 密钥
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key

# 可选 - 其他模型提供商
GOOGLE_API_KEY=your_google_api_key
FIREWORKS_API_KEY=your_fireworks_api_key
GROQ_API_KEY=your_groq_api_key

# 必需 - LangSmith 追踪
LANGCHAIN_API_KEY=your_langsmith_api_key
LANGCHAIN_TRACING_V2=true
LANGCHAIN_PROJECT=open-canvas-local

# 可选 - 本地模型
OLLAMA_API_URL=http://localhost:11434

# 调试模式 (可选)
BYPASS_AUTH=true
```

**`apps/web/.env` 文件** (前端使用):
```bash
# 必需 - Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE=your_supabase_service_role

# 必需 - LangGraph API
LANGGRAPH_API_URL=http://localhost:54367

# 可选 - 模型启用控制
NEXT_PUBLIC_OPENAI_ENABLED=true
NEXT_PUBLIC_ANTHROPIC_ENABLED=true
NEXT_PUBLIC_FIREWORKS_ENABLED=true
NEXT_PUBLIC_GROQ_ENABLED=true
NEXT_PUBLIC_GEMINI_ENABLED=true
NEXT_PUBLIC_OLLAMA_ENABLED=false

# 调试模式 (可选)
BYPASS_AUTH=true
```

## 🚀 快速启动

### 1. 启动 LangGraph 服务

```bash
cd apps/agents
yarn dev
```

服务启动后会显示：
```
Ready!
- 🚀 API: http://localhost:54367
- 🎨 Studio UI: https://smith.langchain.com/studio?baseUrl=http://localhost:54367
```

### 2. 启动前端应用

```bash
cd apps/web
yarn dev
```

前端启动后会显示：
```
- Local:        http://localhost:3000
- Network:      http://192.168.x.x:3000
```

### 3. 访问应用

打开浏览器访问 [http://localhost:3000](http://localhost:3000)

### 4. 验证功能

1. **认证测试**: 注册/登录账户
2. **模型测试**: 选择不同模型进行对话
3. **工件生成**: 创建代码或文档
4. **记忆系统**: 观察 AI 如何记住你的偏好

## 📚 核心概念

### 1. LangGraph 工作流

Open Canvas 使用 LangGraph 管理复杂的 AI 工作流：

```typescript
// 主工作流图
const builder = new StateGraph(OpenCanvasGraphAnnotation)
  .addNode("generatePath", generatePath)           // 路径生成
  .addNode("generateArtifact", generateArtifact)  // 工件生成
  .addNode("rewriteArtifact", rewriteArtifact)    // 工件重写
  .addNode("updateArtifact", updateArtifact)      // 工件更新
  .addNode("generateFollowup", generateFollowup)  // 后续生成
  .addNode("reflect", reflectNode)                // 反思节点
  .addNode("webSearch", webSearchGraph)           // 网络搜索
```

### 2. 多图协作

项目包含多个协作的 LangGraph 图：

- **主代理图** (`agent`): 处理用户交互和工件生成
- **反思图** (`reflection`): 生成用户偏好记忆
- **标题生成图** (`thread_title`): 为对话生成标题
- **摘要图** (`summarizer`): 生成对话摘要
- **网络搜索图** (`web_search`): 执行网络搜索

### 3. 状态管理

#### 图状态 (LangGraph)
```typescript
export const OpenCanvasGraphAnnotation = Annotation.Root({
  _messages: Annotation<BaseMessage[]>,     // 消息历史
  artifact: Annotation<ArtifactV3>,         // 当前工件
  highlightedCode: Annotation<CodeHighlight>, // 高亮代码
  highlightedText: Annotation<TextHighlight>, // 高亮文本
  next: Annotation<string>,                 // 下一个节点
  // ... 更多状态
});
```

#### 前端状态 (React Context)
```typescript
// GraphContext - 管理图执行状态
interface GraphData {
  runId: string;
  isStreaming: boolean;
  messages: BaseMessage[];
  artifact: ArtifactV3;
  // ... 更多状态
}

// ThreadProvider - 管理线程和模型配置
interface ThreadContentType {
  threadId: string;
  modelName: ALL_MODEL_NAMES;
  modelConfigs: Record<ALL_MODEL_NAMES, CustomModelConfig>;
  // ... 更多状态
}
```

### 4. 模型配置系统

统一的模型配置接口支持多种提供商：

```typescript
// 模型配置示例
const modelConfig = {
  modelName: "gpt-4o",
  modelProvider: "openai",
  apiKey: process.env.OPENAI_API_KEY,
  temperature: 0.5,
  maxTokens: 4096
};
```

支持的模型提供商：
- **OpenAI**: GPT-4o, GPT-4o Mini, o1 系列
- **Anthropic**: Claude 3.5 Sonnet, Claude 3 Haiku
- **Google**: Gemini 2.0 Flash, Gemini Pro
- **Fireworks**: Llama 3.3 70B, DeepSeek V3
- **Groq**: DeepSeek R1, Llama 3.1
- **Azure OpenAI**: 企业级部署
- **Ollama**: 本地部署模型

## 💻 开发指南

### 项目结构

```
open-canvas/
├── apps/
│   ├── web/                 # Next.js 前端应用
│   │   ├── src/
│   │   │   ├── app/         # Next.js App Router
│   │   │   ├── components/  # React 组件
│   │   │   ├── contexts/    # React Context
│   │   │   ├── hooks/       # 自定义 Hooks
│   │   │   └── lib/         # 工具函数
│   │   └── package.json
│   └── agents/              # LangGraph 后端服务
│       ├── src/
│       │   ├── open-canvas/ # 主代理图
│       │   ├── reflection/  # 反思图
│       │   ├── thread-title/# 标题生成图
│       │   ├── summarizer/  # 摘要图
│       │   ├── web-search/  # 网络搜索图
│       │   └── utils.ts     # 工具函数
│       └── package.json
├── packages/
│   ├── shared/              # 共享类型和常量
│   └── evals/               # 评估工具
├── langgraph.json           # LangGraph 配置
└── package.json             # 根配置
```

### 开发工作流

#### 1. 添加新模型

**步骤 1**: 在 `packages/shared/src/models.ts` 中添加模型定义
```typescript
export const NEW_MODEL: ModelConfig = {
  name: "new-model",
  displayName: "New Model",
  provider: "new-provider",
  // ... 其他配置
};
```

**步骤 2**: 在 `apps/agents/src/utils.ts` 中添加提供商支持
```typescript
if (customModelName.includes("new-provider/")) {
  return {
    modelName: actualModelName,
    modelProvider: "new-provider",
    apiKey: process.env.NEW_PROVIDER_API_KEY,
  };
}
```

**步骤 3**: 安装必要的依赖包
```bash
cd apps/agents
yarn add @langchain/new-provider
```

**步骤 4**: 配置环境变量
```bash
NEW_PROVIDER_API_KEY=your_api_key
NEXT_PUBLIC_NEW_PROVIDER_ENABLED=true
```

#### 2. 添加新节点

**步骤 1**: 在 `apps/agents/src/open-canvas/nodes/` 中创建节点文件
```typescript
// apps/agents/src/open-canvas/nodes/new-node/index.ts
export const newNode = async (
  state: typeof OpenCanvasGraphAnnotation.State,
  config: LangGraphRunnableConfig
): Promise<OpenCanvasGraphReturnType> => {
  // 节点逻辑
  const model = await getModelFromConfig(config);
  const response = await model.invoke([...messages]);
  
  return {
    // 状态更新
  };
};
```

**步骤 2**: 在 `apps/agents/src/open-canvas/index.ts` 中注册节点
```typescript
const builder = new StateGraph(OpenCanvasGraphAnnotation)
  .addNode("newNode", newNode)
  // ... 其他节点
```

**步骤 3**: 配置节点间的边和路由
```typescript
.addEdge("existingNode", "newNode")
.addConditionalEdges("newNode", routeFunction, ["nextNode1", "nextNode2"])
```

#### 3. 添加新工具

**步骤 1**: 定义工具模式
```typescript
const NEW_TOOL_SCHEMA = z.object({
  parameter: z.string().describe("工具参数"),
  // ... 其他参数
});
```

**步骤 2**: 在节点中绑定工具
```typescript
const modelWithTool = model.bindTools([
  {
    name: "new_tool",
    description: "工具描述",
    schema: NEW_TOOL_SCHEMA,
  }
]);
```

**步骤 3**: 处理工具调用结果
```typescript
const response = await modelWithTool.invoke([...messages]);
const toolCall = response.tool_calls?.[0];
if (toolCall?.name === "new_tool") {
  const args = toolCall.args;
  // 处理工具调用
}
```

### 调试技巧

#### 1. 使用 LangGraph Studio

访问 [https://smith.langchain.com/studio?baseUrl=http://localhost:54367](https://smith.langchain.com/studio?baseUrl=http://localhost:54367) 进行可视化调试。

#### 2. 控制台日志

在节点中添加调试日志：
```typescript
console.log("节点执行开始", { state, config });
console.log("模型响应", response);
```

#### 3. LangSmith 追踪

设置环境变量启用追踪：
```bash
LANGCHAIN_TRACING_V2=true
LANGCHAIN_PROJECT=debug-project
```

#### 4. VS Code 调试

配置 `.vscode/launch.json`:
```json
{
  "name": "Debug LangGraph Agents",
  "type": "node",
  "request": "launch",
  "program": "${workspaceFolder}/debug-agents.js",
  "console": "integratedTerminal"
}
```

## ❓ 常见问题

### 1. 启动问题

**Q: LangGraph 服务启动失败**
```bash
# 检查端口是否被占用
netstat -ano | findstr :54367

# 杀死占用进程
taskkill /PID <PID> /F
```

**Q: 前端无法连接到后端**
- 确认 LangGraph 服务正在运行
- 检查 `LANGGRAPH_API_URL` 环境变量
- 确认防火墙设置

**Q: 认证失败**
- 检查 Supabase 配置
- 确认环境变量正确设置
- 尝试设置 `BYPASS_AUTH=true` 进行调试

### 2. 模型问题

**Q: 模型调用失败**
- 检查 API 密钥是否正确
- 确认模型提供商服务状态
- 查看控制台错误日志

**Q: 工具调用失败**
- 确认模型支持工具调用
- 检查工具模式定义
- 查看 LangSmith 追踪日志

### 3. 开发问题

**Q: TypeScript 类型错误**
```bash
# 重新构建项目
yarn build

# 检查类型定义
yarn tsc --noEmit
```

**Q: 依赖冲突**
```bash
# 清理并重新安装
rm -rf node_modules yarn.lock
yarn install
```

**Q: 热重载不工作**
- 重启开发服务器
- 检查文件监听设置
- 确认文件保存

### 4. 性能问题

**Q: 响应速度慢**
- 检查网络连接
- 尝试不同的模型
- 优化提示词长度

**Q: 内存使用过高**
- 检查状态管理
- 优化消息历史长度
- 使用流式处理

## 🔧 进阶定制

### 1. 自定义 UI 组件

**添加新组件**:
```typescript
// apps/web/src/components/custom/MyComponent.tsx
export const MyComponent = () => {
  return (
    <div className="my-custom-component">
      {/* 组件内容 */}
    </div>
  );
};
```

**集成到现有界面**:
```typescript
// 在现有组件中导入和使用
import { MyComponent } from "@/components/custom/MyComponent";
```

### 2. 自定义工作流

**创建新的图**:
```typescript
// apps/agents/src/custom-graph/index.ts
export const customGraph = new StateGraph(CustomGraphAnnotation)
  .addNode("start", startNode)
  .addNode("process", processNode)
  .addNode("end", endNode)
  .addEdge("start", "process")
  .addEdge("process", "end");
```

**注册到 LangGraph**:
```json
// langgraph.json
{
  "graphs": {
    "custom": "./apps/agents/src/custom-graph/index.ts:customGraph"
  }
}
```

### 3. 集成外部服务

**添加新的 API 集成**:
```typescript
// apps/agents/src/integrations/new-service.ts
export class NewServiceIntegration {
  async callAPI(params: any) {
    const response = await fetch('https://api.newservice.com', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.NEW_SERVICE_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(params),
    });
    return response.json();
  }
}
```

### 4. 部署配置

**Docker 部署**:
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN yarn install
COPY . .
RUN yarn build
EXPOSE 3000 54367
CMD ["yarn", "start"]
```

**环境变量管理**:
```bash
# 生产环境配置
NODE_ENV=production
LANGGRAPH_API_URL=https://your-domain.com
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
```

### 5. 监控和日志

**添加自定义监控**:
```typescript
// apps/agents/src/monitoring/custom-metrics.ts
export const trackCustomMetric = (metric: string, value: number) => {
  // 发送到监控服务
  console.log(`Metric: ${metric}, Value: ${value}`);
};
```

**结构化日志**:
```typescript
// 使用结构化日志
console.log(JSON.stringify({
  timestamp: new Date().toISOString(),
  level: 'info',
  message: 'Node executed',
  nodeName: 'generateArtifact',
  duration: 1500,
}));
```

## 📖 相关文档

- [技术架构总览](./技术架构总览.md) - 详细的架构分析
- [LangChain 与 LangGraph 关系分析](./LangChain与LangGraph关系分析.md) - 框架协作机制
- [模型配置与 API 端点分析](./模型配置与API端点分析.md) - 模型集成指南
- [DashScope 配置说明](./DashScope配置说明.md) - 阿里云模型配置

## 🤝 贡献指南

### 开发流程

1. **Fork 项目**: 创建自己的分支
2. **创建功能分支**: `git checkout -b feature/new-feature`
3. **开发功能**: 编写代码和测试
4. **提交更改**: `git commit -m "Add new feature"`
5. **推送分支**: `git push origin feature/new-feature`
6. **创建 PR**: 提交 Pull Request

### 代码规范

- 使用 TypeScript 进行类型安全开发
- 遵循 ESLint 和 Prettier 配置
- 编写清晰的注释和文档
- 保持代码的模块化和可测试性

### 测试要求

- 为新功能编写单元测试
- 确保集成测试的覆盖率
- 进行端到端测试验证

---

## 📞 获取帮助

- **GitHub Issues**: [项目 Issues 页面](https://github.com/langchain-ai/open-canvas/issues)
- **技术讨论**: [项目 Discussions 页面](https://github.com/langchain-ai/open-canvas/discussions)
- **官方文档**: [LangChain 文档](https://langchain-ai.github.io/langgraphjs/)

---

*最后更新时间: 2024年12月*

**祝您使用愉快！🎉**
