# 环境变量配置指南

## 概述

本文档说明如何配置 Open Canvas 项目的环境变量，特别是 Redis 缓存配置。

## 必需的环境变量

### Supabase 配置
```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

### Redis 缓存配置（二选一）

#### 方案一：Upstash Redis（推荐）
```env
UPSTASH_REDIS_REST_URL=your_upstash_redis_url
UPSTASH_REDIS_REST_TOKEN=your_upstash_redis_token
```

#### 方案二：传统 Redis
```env
REDIS_URL=redis://localhost:6379
```

## 模型 API 配置

### OpenAI
```env
OPENAI_API_KEY=your_openai_api_key
```

### Anthropic
```env
ANTHROPIC_API_KEY=your_anthropic_api_key
```

### Azure OpenAI
```env
_AZURE_OPENAI_API_KEY=your_azure_openai_api_key
_AZURE_OPENAI_API_INSTANCE_NAME=your_azure_openai_instance_name
_AZURE_OPENAI_API_DEPLOYMENT_NAME=your_azure_openai_deployment_name
_AZURE_OPENAI_API_VERSION=2024-08-01-preview
_AZURE_OPENAI_API_BASE_PATH=your_azure_openai_base_path
```

### Fireworks
```env
FIREWORKS_API_KEY=your_fireworks_api_key
```

### Google
```env
GOOGLE_API_KEY=your_google_api_key
```

### Groq
```env
GROQ_API_KEY=your_groq_api_key
```

## 应用配置

```env
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

## Upstash Redis 配置步骤

### 1. 创建 Upstash Redis 实例

1. 访问 [Upstash Console](https://console.upstash.com/)
2. 点击 "Create Database"
3. 选择 "Global" 或 "Regional" 部署
4. 选择 Redis 版本（推荐 7.x）
5. 点击 "Create"

### 2. 获取连接信息

创建完成后，在数据库详情页面可以找到：
- **REST URL**: `https://your-db.upstash.io`
- **REST Token**: `your-token-here`

### 3. 配置环境变量

将获取的信息添加到 `.env.local` 文件：
```env
UPSTASH_REDIS_REST_URL=https://your-db.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-token-here
```

### 4. 验证配置

重启应用后，查看控制台日志：
- ✅ 成功：`✅ Upstash Redis 连接成功`
- ❌ 失败：`❌ Upstash Redis 连接失败`

## 缓存性能优化

### 推荐配置

```env
# 缓存配置
CACHE_DEFAULT_TTL=300          # 5分钟
CACHE_MAX_MEMORY_SIZE=52428800 # 50MB
CACHE_CLEANUP_INTERVAL=60000   # 1分钟
CACHE_PREFERRED_BACKEND=auto   # 自动选择最佳后端
```

### 性能监控

应用会自动收集缓存统计信息：
- 缓存命中率
- 响应时间
- 内存使用情况
- 错误率

## 故障排除

### 常见问题

#### 1. Redis 连接失败
**症状**: 控制台显示 Redis 连接错误
**解决方案**:
- 检查环境变量是否正确
- 确认 Redis 服务是否运行
- 检查网络连接

#### 2. 缓存性能不佳
**症状**: 缓存命中率低
**解决方案**:
- 调整 TTL 设置
- 增加内存缓存大小
- 检查缓存键的命名策略

#### 3. 内存使用过高
**症状**: 应用内存占用持续增长
**解决方案**:
- 减少 `CACHE_MAX_MEMORY_SIZE`
- 缩短 `CACHE_DEFAULT_TTL`
- 启用自动清理

### 调试模式

启用调试模式查看详细日志：
```env
NODE_ENV=development
DEBUG_CACHE=true
```

## 安全注意事项

### 1. 密钥管理
- 不要在代码中硬编码密钥
- 使用环境变量或密钥管理服务
- 定期轮换密钥

### 2. 访问控制
- 限制 Redis 访问权限
- 使用强密码
- 启用 TLS 加密

### 3. 监控告警
- 设置缓存命中率告警
- 监控异常访问模式
- 定期检查日志

## 最佳实践

### 1. 缓存策略
- 为不同类型的数据设置不同的 TTL
- 使用有意义的缓存键命名
- 实现缓存预热机制

### 2. 错误处理
- 实现优雅降级
- 记录详细的错误日志
- 提供用户友好的错误信息

### 3. 性能优化
- 使用批量操作
- 实现缓存压缩
- 监控缓存统计信息

## 总结

通过正确配置环境变量，特别是 Redis 缓存配置，可以显著提升应用性能。推荐使用 Upstash Redis 作为缓存后端，它提供了更好的性能和可靠性。
